<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>EduBridge Uganda · Admin + analytics</title>
    <meta name="description" content="Professional Admin Dashboard – Ugandan school format (UGX, local districts)">
    <!-- Fonts, Icons & Charts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,400..700;1,14..32,400..700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: #f8fafc;
            color: #0f172a;
        }
        .admin-wrapper { display: flex; min-height: 100vh; }

        /* ---------- SIDEBAR ---------- */
        .admin-sidebar {
            width: 280px;
            background: linear-gradient(135deg, #0d3b66 0%, #1a5a8f 100%);
            color: white;
            display: flex;
            flex-direction: column;
            box-shadow: 8px 0 30px rgba(13, 59, 102, 0.25);
            position: sticky; top:0; height:100vh;
            overflow: hidden;
        }
        .sidebar-brand {
            padding: 28px 24px;
            display: flex; align-items: center; gap: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            flex-shrink: 0;
        }
        .sidebar-brand i { font-size: 2rem; color: #fbbf24; }
        .sidebar-brand h1 { font-size: 1.5rem; font-weight:700; color:white; }
        .sidebar-user {
            margin: 20px 16px; padding: 16px 18px;
            background: rgba(6,182,212,0.08); border-radius: 18px;
            border: 1px solid rgba(6,182,212,0.2);
            flex-shrink: 0;
        }
        .sidebar-user strong { display:block; color:white; }
        .sidebar-user-email { font-size:0.75rem; color:rgba(255,255,255,0.7); }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding-right: 8px;
        }
        
        .sidebar-content::-webkit-scrollbar {
            width: 6px;
        }
        
        .sidebar-content::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
        }
        
        .sidebar-content::-webkit-scrollbar-thumb {
            background: rgba(16,185,129,0.4);
            border-radius: 10px;
        }
        
        .sidebar-content::-webkit-scrollbar-thumb:hover {
            background: rgba(16,185,129,0.6);
        }
        
        .sidebar-section-title {
            font-size:0.7rem; text-transform:uppercase; letter-spacing:0.5px;
            color:rgba(255,255,255,0.5); padding:20px 24px 8px 24px;
        }
        .sidebar-menu { list-style:none; padding:0 12px; }
        .sidebar-menu li { margin-bottom:2px; }
        .sidebar-menu a {
            display:flex; align-items:center; gap:14px; padding:12px 18px;
            border-radius:12px; color:rgba(255,255,255,0.8); text-decoration:none;
            font-weight:500; font-size:0.9rem; transition:0.2s;
        }
        .sidebar-menu a i { width:22px; font-size:1.2rem; color: #10b981; }
        .sidebar-menu a:hover, .sidebar-menu a.active {
            background:rgba(16,185,129,0.16); color:white; transform:translateX(4px);
        }
        .sidebar-footer { 
            padding:20px 16px 28px; 
            border-top: 1px solid rgba(255,255,255,0.08);
            flex-shrink: 0;
        }
        .logout-btn {
            width:100%; padding:14px; background:rgba(239,68,68,0.1);
            border:1px solid rgba(239,68,68,0.3); border-radius:14px;
            color:#fca5a5; font-weight:600; display:flex; align-items:center;
            justify-content:center; gap:10px; cursor:pointer; transition:0.2s;
        }
        .logout-btn:hover { background:rgba(239,68,68,0.25); color:#fff; border-color:#ef4444; }

        /* ---------- MAIN CONTENT ---------- */
        .admin-main {
            flex:1; background:#f8fafc; padding:32px 40px; overflow-y:auto;
        }
        .admin-header {
            display:flex; justify-content:space-between; align-items:center;
            background:rgba(255,255,255,0.85); backdrop-filter:blur(8px);
            border:1px solid rgba(226,232,240,0.5); border-radius:32px;
            padding:18px 32px; margin-bottom:36px; box-shadow:0 10px 25px -8px rgba(13,59,102,0.08);
        }
        .admin-header h1 { font-size:1.9rem; font-weight:700; color:#0d3b66; display:flex; align-items:center; gap:8px; }
        .admin-header h1 i { color:#fbbf24; }
        .header-actions { display:flex; gap:12px; }
        .btn-icon {
            background:white; border:none; width:44px; height:44px; border-radius:50%;
            color:#0d3b66; font-size:1.2rem; cursor:pointer; box-shadow:0 4px 8px rgba(0,0,0,0.02);
            transition:0.2s; display:flex; align-items:center; justify-content:center;
        }
        .btn-icon:hover { background:#10b981; color:white; transform:translateY(-2px); }

        /* Header controls & search */
        .admin-header { gap:16px; }
        .header-left { display:flex; flex-direction:column; }
        .header-sub { font-size:0.9rem; color:#64748b; margin-top:6px; }
        .header-controls { display:flex; align-items:center; gap:12px; }
        .search-wrapper { position:relative; display:flex; align-items:center; }
        .search-wrapper input { width:320px; padding:10px 40px 10px 14px; border-radius:12px; border:1px solid #e2e8f0; background:white; box-shadow:0 6px 18px rgba(16,185,129,0.04); transition:0.18s; }
        .search-wrapper input:focus { outline:none; transform:translateY(-2px); box-shadow:0 12px 30px rgba(16,185,129,0.08); }
        .search-wrapper button { position:absolute; right:6px; background:transparent; border:none; color:#64748b; cursor:pointer; font-size:0.95rem; }
        .date-range { display:flex; align-items:center; gap:8px; background:transparent; }
        .date-range input { border:1px solid #e2e8f0; padding:8px 10px; border-radius:8px; }
        .dash { color:#94a3b8; }
        .view-toggle button { background:transparent; border:1px solid #e6eef5; padding:8px 10px; border-radius:8px; cursor:pointer; color:#0d3b66; }
        .view-toggle button.active { background:#10b981; color:white; border-color:transparent; }

        /* Stat card subtle animation */
        .stat-card { transform:translateY(0); will-change:transform,box-shadow; }
        .stat-value { transition: transform 0.45s cubic-bezier(.2,.9,.3,1); }
        .stat-value.pop { transform: scale(1.06); color:#059669; }

        /* stats cards (compact-first design) */
        .stats-grid {
            display:grid; grid-template-columns:repeat(auto-fit, minmax(140px,1fr));
            gap:14px; margin-bottom:28px;
        }
        .stat-card {
            background:white; border-radius:14px; padding:14px 12px;
            box-shadow:0 6px 14px rgba(13,59,102,0.04); border:1px solid rgba(226,232,240,0.6);
            transition:transform 0.18s, box-shadow 0.18s; display:flex; flex-direction:column; align-items:flex-start;
            border-left: 3px solid #10b981; min-height:62px;
        }
        .stat-card:hover { transform:translateY(-4px); box-shadow:0 14px 28px rgba(16,185,129,0.08); }
        .stat-card:nth-child(even) { border-left-color: #fbbf24; }
        .stat-icon { font-size:1.4rem; margin-bottom:6px; color:#0d3b66; }
        .stat-label { font-size:0.65rem; font-weight:700; text-transform:uppercase; color:#64748b; letter-spacing:0.6px; }
        .stat-value { font-size:1.25rem; font-weight:800; color:#0d3b66; line-height:1.1; margin:6px 0; }
        .stat-change { font-size:0.68rem; color:#10b981; display:flex; align-items:center; gap:6px; }

        /* Denser compact view activated by view toggle */
        body.compact .stats-grid { gap:10px; }
        body.compact .stat-card { padding:10px 8px; border-radius:10px; min-height:48px; }
        body.compact .stat-icon { font-size:1.1rem; }
        body.compact .stat-label { font-size:0.6rem; }
        body.compact .stat-value { font-size:1rem; }
        body.compact .stat-change { font-size:0.6rem; }

        /* chart grid */
        .charts-grid {
            display:grid; grid-template-columns:repeat(auto-fit, minmax(320px,1fr));
            gap:24px; margin-bottom:48px;
        }
        .chart-card {
            background:white; border-radius:32px; padding:24px; box-shadow:0 12px 28px -8px rgba(0,0,0,0.04);
        }
        .chart-card h3 {
            font-size:1.1rem; font-weight:600; color:#0d3b66; margin-bottom:16px;
            display:flex; align-items:center; gap:8px;
        }
        .chart-card h3 i { color:#fbbf24; }
        .chart-container { position:relative; height:300px; width:100%; }

        /* category breakdown */
        .section-title { font-size:1.5rem; font-weight:700; color:#0d3b66; margin:40px 0 24px; }
        .management-grid {
            display:grid; grid-template-columns:repeat(auto-fit, minmax(200px,1fr));
            gap:20px; margin-bottom:40px;
        }
        .management-card {
            background:white; border-radius:28px; padding:24px; text-decoration:none; color:inherit;
            box-shadow:0 10px 20px -8px rgba(13,59,102,0.06); transition:0.25s; position:relative;
        }
        .management-card:hover { transform:scale(1.02) translateY(-4px); box-shadow:0 24px 40px -12px rgba(16,185,129,0.2); }
        .management-card-icon { font-size:2.5rem; margin-bottom:12px; }
        .management-card h3 { font-size:1.2rem; font-weight:700; margin-bottom:6px; }
        .management-card p { font-size:0.8rem; color:#64748b; }
        .category-breakdown {
            background:white; border-radius:28px; padding:28px; margin-bottom:40px;
        }
        .category-item { margin-bottom:16px; }
        .category-info { display:flex; justify-content:space-between; margin-bottom:6px; font-size:0.9rem; }
        .category-bar { height:8px; background:#e2e8f0; border-radius:20px; overflow:hidden; }
        .category-fill { height:8px; background:linear-gradient(90deg,#10b981,#06b6d4); border-radius:20px; }

        /* quick actions */
        .quick-actions { display:flex; flex-wrap:wrap; gap:14px; margin-bottom:40px; }
        .quick-action-btn {
            background:white; border:none; padding:14px 26px; border-radius:50px;
            font-weight:600; color:#0d3b66; display:flex; align-items:center; gap:12px;
            box-shadow:0 4px 12px rgba(0,0,0,0.02); cursor:pointer; transition:0.2s;
        }
        .quick-action-btn:hover { background:#10b981; color:white; transform:translateY(-2px); }
        .quick-action-btn:nth-child(even):hover { background:#fbbf24; color:#0d3b66; }

        .info-box {
            background:white; border-radius:28px; padding:28px; box-shadow:0 12px 24px -10px rgba(0,0,0,0.04);
        }
        .data-section { background:white; border-radius:28px; padding:24px; margin-top:24px; }
        .table-wrapper { overflow-x:auto; }
        .table { width:100%; border-collapse:collapse; }
        .table th { text-align:left; padding:16px 12px; background:#f8fafc; font-weight:600; color:#0d3b66; }
        .table td { padding:12px; border-bottom:1px solid #e2e8f0; }
        .badge { padding:4px 12px; border-radius:40px; font-size:0.75rem; font-weight:600; }
        .badge-success { background:#d1fae5; color:#065f46; }

        footer {
            background:#0d3b66; color:white; border-radius:48px 48px 0 0; margin-top:48px;
            padding:48px 40px 24px;
        }
        .footer-content {
            max-width:1200px; margin:0 auto; display:grid;
            grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:40px;
        }
        .footer-section h3 { color:#fbbf24; margin-bottom:16px; }
        .footer-section a, .footer-section p { color:#cbd5e0; font-size:0.9rem; text-decoration:none; }
        .social-links a {
            background:rgba(16,185,129,0.15); width:40px; height:40px; border-radius:50%;
            display:inline-flex; align-items:center; justify-content:center; margin-right:8px;
            color:#10b981; transition:0.2s;
        }
        .social-links a:hover { background:#10b981; color:white; }
        .footer-bottom { text-align:center; padding-top:32px; color:#8da0b5; }

        .section-content { display:none; }
        .section-content.active { display:block; }
        .loading { width:16px; height:16px; border:2px solid #eee; border-top-color:#f39c12; border-radius:50%; animation:spin 0.8s linear infinite; display:inline-block; }
        @keyframes spin { to { transform:rotate(360deg); } }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f8fafc;
        }
        .modal-header h2 { margin: 0; color: #0d3b66; font-size: 24px; }
        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            transition: 0.2s;
        }
        .modal-close:hover { color: #0d3b66; }

        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #0d3b66;
            font-size: 14px;
        }
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
            transition: all 0.2s;
        }
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 640px) {
            .form-row { grid-template-columns: 1fr; }
        }

        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #f8fafc;
        }
        .btn-submit {
            background: #10b981;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.2s;
        }
        .btn-submit:hover { background: #059669; }
        .btn-cancel {
            background: #e2e8f0;
            color: #0d3b66;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.2s;
        }
        .btn-cancel:hover { background: #cbd5e0; }

        .btn-edit-table {
            background: #3b82f6;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 6px;
            transition: 0.2s;
        }
        .btn-edit-table:hover { background: #1d4ed8; }
        .btn-delete-table {
            background: #ef4444;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: 0.2s;
        }
        .btn-delete-table:hover { background: #dc2626; }

        .alert {
            padding: 16px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .alert-success { background: #88ddb1; color: #065f46; border-left: 4px solid #10b981; }
        .alert-error { background: #88ddb1; color: #7f1d1d; border-left: 4px solid #ef4444; }
        .alert-info { background: #88ddb1; color: #0c2d6b; border-left: 4px solid #3b82f6; }
        
        /* File upload styles */
        .file-upload-group {
            margin-bottom: 20px;
        }
        .file-upload-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #0d3b66;
            font-size: 14px;
        }
        .file-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .file-input-wrapper input[type="file"] {
            display: none;
        }
        .file-input-label {
            padding: 12px 20px;
            background: #f8fafc;
            border: 2px dashed #10b981;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: #10b981;
            transition: 0.2s;
            flex: 1;
            text-align: center;
        }
        .file-input-label:hover {
            background: #e8f5f0;
            border-color: #059669;
        }
        .file-name-display {
            font-size: 13px;
            color: #64748b;
        }
        .preview-section {
            margin-top: 16px;
            padding: 16px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        .preview-section h4 {
            margin: 0 0 12px 0;
            font-size: 13px;
            font-weight: 600;
            color: #0d3b66;
        }
        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 8px;
        }
        .preview-item {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 6px;
            overflow: hidden;
            background: white;
            border: 1px solid #e2e8f0;
        }
        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .preview-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .preview-remove {
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }
        .preview-remove:hover {
            background: rgba(239, 68, 68, 1);
        }
    </style>
</head>
<body>
<div class="admin-wrapper">
    <!-- SIDEBAR -->
    <div class="admin-sidebar">
        <div class="sidebar-brand"><i class="fas fa-graduation-cap"></i><h1>EduBridge Uganda</h1></div>
        <div class="sidebar-user"><strong id="sidebarUserName">Admin</strong><div class="sidebar-user-email" id="sidebarUserEmail">admin@edubridge.ug</div></div>
        
        <div class="sidebar-content">
            <div class="sidebar-section-title">Core</div>
            <ul class="sidebar-menu">
                <li><a href="#" class="nav-link active" data-section="dashboard"><i class="fas fa-chart-line"></i> Dashboard</a></li>
                <li><a href="#" class="nav-link" data-section="schools"><i class="fas fa-school"></i> Schools</a></li>
                <li><a href="#" class="nav-link" data-section="events"><i class="fas fa-calendar"></i> Events</a></li>
                <li><a href="#" class="nav-link" data-section="jobs"><i class="fas fa-briefcase"></i> Jobs</a></li>
            </ul>

            <div class="sidebar-section-title">Management</div>
            <ul class="sidebar-menu">
                <li><a href="#" class="nav-link" data-section="bursaries"><i class="fas fa-graduation-cap"></i> Bursaries</a></li>
                <li><a href="#" class="nav-link" data-section="agents"><i class="fas fa-users"></i> Agents</a></li>
                <li><a href="#" class="nav-link" data-section="papers"><i class="fas fa-file-pdf"></i> Past Papers</a></li>
                <li><a href="#" class="nav-link" data-section="suggestions"><i class="fas fa-comments"></i> Suggestions</a></li>
                <li><a href="#" class="nav-link" data-section="users"><i class="fas fa-users-cog"></i> Users</a></li>
            </ul>
        </div>

        <div class="sidebar-footer"><button class="logout-btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button></div>
    </div>

    <!-- MAIN PANEL -->
    <div class="admin-main">
        <div class="admin-header">
            <div class="header-left">
                <h1><i class="fas fa-chart-line"></i> <span id="headerTitle">Dashboard</span></h1>
                <div class="header-sub">Manage schools, events, users and insights</div>
            </div>
            <div class="header-controls">
                <div class="search-wrapper">
                    <input id="globalSearch" type="search" placeholder="Search schools, events, users..." aria-label="Search">
                    <button id="clearSearch" title="Clear"><i class="fas fa-times"></i></button>
                </div>
                <div class="date-range">
                    <input id="dateStart" type="date" title="From">
                    <span class="dash">—</span>
                    <input id="dateEnd" type="date" title="To">
                </div>
                <div class="view-toggle" title="Toggle compact/expanded view">
                    <button id="viewCompact" class="active" title="Compact"><i class="fas fa-list"></i></button>
                    <button id="viewExpanded" title="Expanded"><i class="fas fa-th-large"></i></button>
                </div>
                <div class="header-actions">
                    <button class="btn-icon" id="refreshBtn"><i class="fas fa-sync-alt"></i></button>
                    <button class="btn-icon" id="settingsBtn"><i class="fas fa-cog"></i></button>
                </div>
            </div>
        </div>

        <!-- DASHBOARD (active) with UGANDAN stats -->
        <div id="dashboard-section" class="section-content active">
            <!-- STATS CARDS (Ugandan data) -->
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-label">Schools</div><div class="stat-value" id="totalSchools">0</div><div class="stat-change"><i class="fas fa-arrow-up"></i> <span id="schoolGrowth">+3 districts</span></div></div>
                <div class="stat-card"><div class="stat-label">Students (est)</div><div class="stat-value" id="totalStudents">0</div><div class="stat-change"><span id="studentGrowth">+7.2%</span></div></div>
                <div class="stat-card"><div class="stat-label">Avg students / school</div><div class="stat-value" id="avgStudents">0</div><div class="stat-change"><span id="avgStudentsChange">—</span></div></div>
                <div class="stat-card"><div class="stat-label">Upcoming events (30d)</div><div class="stat-value" id="upcomingEvents">0</div><div class="stat-change"><span id="upcomingDesc">Next 30 days</span></div></div>
                <div class="stat-card"><div class="stat-label">Total events</div><div class="stat-value" id="totalEvents">0</div><div class="stat-change"><span id="eventGrowth">+2 this term</span></div></div>
                <div class="stat-card"><div class="stat-label">Jobs</div><div class="stat-value" id="totalJobs">0</div><div class="stat-change"><span id="openJobs">open</span></div></div>
                <div class="stat-card"><div class="stat-label">Active agents</div><div class="stat-value" id="activeAgents">0</div><div class="stat-change"><span id="agentGrowth">+3</span></div></div>
                <div class="stat-card"><div class="stat-label">Bursaries</div><div class="stat-value" id="totalBursaries">0</div><div class="stat-change">UGX <span id="bursaryTotal">0</span></div></div>
                <div class="stat-card"><div class="stat-label">Avg bursary (UGX)</div><div class="stat-value" id="avgBursary">0</div><div class="stat-change"><span id="bursaryChange">—</span></div></div>
                <div class="stat-card"><div class="stat-label">Papers</div><div class="stat-value" id="totalPapers">0</div><div class="stat-change"><span id="paperGrowth">+8 resources</span></div></div>
                <div class="stat-card"><div class="stat-label">Users</div><div class="stat-value" id="totalUsers">0</div><div class="stat-change"><span id="userGrowth">+1</span></div></div>
                <div class="stat-card"><div class="stat-label">Suggestions (open)</div><div class="stat-value" id="suggestionsPending">0</div><div class="stat-change"><span id="suggestionChange">—</span></div></div>
            </div>

            <!-- GRAPHS SECTION (with Ugandan labels) -->
            <div class="charts-grid">
                <div class="chart-card">
                    <h3><i class="fas fa-chart-pie"></i> Schools by district</h3>
                    <div class="chart-container"><canvas id="categoryPieChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <h3><i class="fas fa-chart-bar"></i> New schools per term</h3>
                    <div class="chart-container"><canvas id="growthBarChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <h3><i class="fas fa-chart-line"></i> Bursary applications</h3>
                    <div class="chart-container"><canvas id="applicationsLineChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <h3><i class="fas fa-chart-radar"></i> Resource distribution</h3>
                    <div class="chart-container"><canvas id="resourceRadarChart"></canvas></div>
                </div>
            </div>

            <!-- category breakdown (Ugandan districts) -->
            <h2 class="section-title">Schools by district (detail)</h2>
            <div class="category-breakdown" id="categoryBreakdown"></div>

            <!-- quick actions -->
            <h2 class="section-title">Quick actions</h2>
            <div class="quick-actions">
                <button class="quick-action-btn" onclick="alert('Add school (Ugandan district)')"><i class="fas fa-plus"></i> Add School</button>
                <button class="quick-action-btn" onclick="refreshDashboard()"><i class="fas fa-sync-alt"></i> Refresh graphs</button>
            </div>

            <!-- info box with live UGX calculations -->
            <div class="info-box" id="liveCalculations">
                <h3><i class="fas fa-calculator"></i> Live platform calculations (Uganda)</h3>
                <p><strong>Total schools (UGA):</strong> <span id="calcSchools">0</span> | <strong>Avg students per school:</strong> <span id="avgStudents">0</span></p>
                <p><strong>Total estimated enrollment:</strong> <span id="totalEnrollment">0</span> students</p>
                <p><strong>Most common district:</strong> <span id="topCategory">Kampala</span> · <strong>Term growth rate:</strong> <span id="growthRate">5.1%</span></p>
                <p><strong>Bursary coverage (UGX):</strong> <span id="bursaryCoverage">42%</span> · <strong>Active agents:</strong> <span id="activeAgents">14</span></p>
                <p><strong>Total bursary fund:</strong> UGX <span id="totalBursaryUgx">126,500,000</span></p>
            </div>
        </div>

        <!-- Other sections (same structure, but Ugandan format can be added if needed) -->
        <div id="schools-section" class="section-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2 style="color: #0d3b66; font-size: 24px; margin: 0;">Schools Management</h2>
                <button class="quick-action-btn" id="addSchoolBtn" style="margin: 0;">
                    <i class="fas fa-plus"></i> Add School
                </button>
            </div>

            <div id="schoolsAlert"></div>

            <div class="data-section">
                <div class="table-wrapper">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>School Name</th>
                                <th>Category</th>
                                <th>District</th>
                                <th>Students</th>
                                <th>Email</th>
                                <th>Actions</th>
                                <th></th>
                                    
                            </tr>
                        </thead>
                        <tbody id="schoolsTableBody">
                            <tr><td colspan="6" style="text-align: center; padding: 40px;"><span class="loading"></span> Loading schools...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- EVENTS SECTION -->
        <div id="events-section" class="section-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2 style="color: #0d3b66; font-size: 24px; margin: 0;">Events Management</h2>
                <button class="quick-action-btn" id="addEventBtn" style="margin: 0;"><i class="fas fa-plus"></i> Add Event</button>
            </div>
            <div id="eventsAlert"></div>
            <div class="data-section">
                <div class="table-wrapper">
                    <table class="table">
                        <thead><tr><th>Event Name</th><th>Date</th><th>Location</th><th>Type</th><th>Attendees</th><th>Actions</th></tr></thead>
                        <tbody id="eventsTableBody"><tr><td colspan="6" style="text-align: center; padding: 40px;"><span class="loading"></span> Loading events...</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- JOBS SECTION -->
        <div id="jobs-section" class="section-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2 style="color: #0d3b66; font-size: 24px; margin: 0;">Jobs Management</h2>
                <button class="quick-action-btn" id="addJobBtn" style="margin: 0;"><i class="fas fa-plus"></i> Add Job</button>
            </div>
            <div id="jobsAlert"></div>
            <div class="data-section">
                <div class="table-wrapper">
                    <table class="table">
                        <thead><tr><th>Job Title</th><th>Organization</th><th>Location</th><th>Salary</th><th>Posted</th><th>Actions</th></tr></thead>
                        <tbody id="jobsTableBody"><tr><td colspan="6" style="text-align: center; padding: 40px;"><span class="loading"></span> Loading jobs...</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- BURSARIES SECTION -->
        <div id="bursaries-section" class="section-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2 style="color: #0d3b66; font-size: 24px; margin: 0;">Bursaries Management</h2>
                <button class="quick-action-btn" id="addBursaryBtn" style="margin: 0;"><i class="fas fa-plus"></i> Add Bursary</button>
            </div>
            <div id="bursariesAlert"></div>
            <div class="data-section">
                <div class="table-wrapper">
                    <table class="table">
                        <thead><tr><th>Program Name</th><th>Sponsor</th><th>Amount (UGX)</th><th>Category</th><th>Deadline</th><th>Actions</th></tr></thead>
                        <tbody id="bursariesTableBody"><tr><td colspan="6" style="text-align: center; padding: 40px;"><span class="loading"></span> Loading bursaries...</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- AGENTS SECTION -->
        <div id="agents-section" class="section-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2 style="color: #0d3b66; font-size: 24px; margin: 0;">Agents Management</h2>
                <button class="quick-action-btn" id="addAgentBtn" style="margin: 0;"><i class="fas fa-plus"></i> Add Agent</button>
            </div>
            <div id="agentsAlert"></div>
            <div class="data-section">
                <div class="table-wrapper">
                    <table class="table">
                        <thead><tr><th>Agent Name</th><th>Email</th><th>Phone</th><th>Region</th><th>Status</th><th>Actions</th></tr></thead>
                        <tbody id="agentsTableBody"><tr><td colspan="6" style="text-align: center; padding: 40px;"><span class="loading"></span> Loading agents...</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- PAPERS SECTION -->
        <div id="papers-section" class="section-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2 style="color: #0d3b66; font-size: 24px; margin: 0;">Past Papers Management</h2>
                <button class="quick-action-btn" id="addPaperBtn" style="margin: 0;"><i class="fas fa-plus"></i> Add Paper</button>
            </div>
            <div id="papersAlert"></div>
            <div class="data-section">
                <div class="table-wrapper">
                    <table class="table">
                        <thead><tr><th>Subject</th><th>Exam Year</th><th>Exam Level</th><th>School</th><th>File</th><th>Actions</th></tr></thead>
                        <tbody id="papersTableBody"><tr><td colspan="6" style="text-align: center; padding: 40px;"><span class="loading"></span> Loading papers...</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- SUGGESTIONS SECTION -->
        <div id="suggestions-section" class="section-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2 style="color: #0d3b66; font-size: 24px; margin: 0;">Suggestions & Feedback</h2>
                <button class="quick-action-btn" id="addSuggestionBtn" style="margin: 0;"><i class="fas fa-plus"></i> Log Suggestion</button>
            </div>
            <div id="suggestionsAlert"></div>
            <div class="data-section">
                <div class="table-wrapper">
                    <table class="table">
                        <thead><tr><th>From</th><th>Subject</th><th>Message</th><th>Date</th><th>Status</th><th>Actions</th></tr></thead>
                        <tbody id="suggestionsTableBody"><tr><td colspan="6" style="text-align: center; padding: 40px;"><span class="loading"></span> Loading suggestions...</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- USERS SECTION -->
        <div id="users-section" class="section-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2 style="color: #0d3b66; font-size: 24px; margin: 0;">User Management</h2>
                <button class="quick-action-btn" id="addUserBtn" style="margin: 0;"><i class="fas fa-plus"></i> Add User</button>
            </div>
            <div id="usersAlert"></div>
            <div class="data-section">
                <div class="table-wrapper">
                    <table class="table">
                        <thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Joined</th><th>Status</th><th>Actions</th></tr></thead>
                        <tbody id="usersTableBody"><tr><td colspan="6" style="text-align: center; padding: 40px;"><span class="loading"></span> Loading users...</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>


    </div>
</div>

    <!-- School Modal -->
    <div id="schoolModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="schoolModalTitle">Add New School</h2>
                <button class="modal-close" onclick="closeModal('schoolModal')">&times;</button>
            </div>
            <form id="schoolForm" onsubmit="handleSubmit(event, 'schools')">
                <div class="form-row">
                    <div class="form-group"><label for="schoolName">School Name *</label><input type="text" id="schoolName" required></div>
                    <div class="form-group"><label for="schoolCategory">Category *</label><select id="schoolCategory" required><option value="">Select</option><option value="Primary">Primary</option><option value="Secondary">Secondary</option><option value="Technical">Technical</option><option value="University">University</option></select></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label for="schoolDistrict">District *</label><input type="text" id="schoolDistrict" required></div>
                    <div class="form-group"><label for="schoolStudents">Students</label><input type="number" id="schoolStudents"></div>
                </div>
                <div class="form-row"><div class="form-group"><label for="schoolEmail">Email</label><input type="email" id="schoolEmail"></div><div class="form-group"><label for="schoolPhone">Phone</label><input type="tel" id="schoolPhone"></div></div>
                <div class="form-group"><label for="schoolAddress">Address</label><input type="text" id="schoolAddress"></div>
                
                <!-- UPLOAD SECTION: Logo, Images, Videos -->
                <h3 style="margin-top: 28px; margin-bottom: 16px; font-size: 16px; font-weight: 700; color: #0d3b66; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-cloud-upload-alt"></i> Media Uploads
                </h3>
                
                <!-- Logo Upload -->
                <div class="file-upload-group">
                    <label>School Logo</label>
                    <div class="file-input-wrapper">
                        <input type="file" id="schoolLogo" accept="image/*">
                        <label for="schoolLogo" class="file-input-label"><i class="fas fa-image"></i> Choose Logo</label>
                        <span class="file-name-display" id="logoFileName"></span>
                    </div>
                    <div id="logoPreview" class="preview-section" style="display: none;">
                        <h4>Logo Preview</h4>
                        <img id="logoPreviewImg" src="" alt="Logo" style="max-width: 150px; max-height: 150px; border-radius: 6px;">
                    </div>
                </div>
                
                <!-- Images Upload -->
                <div class="file-upload-group">
                    <label>School Images (Multiple)</label>
                    <div class="file-input-wrapper">
                        <input type="file" id="schoolImages" accept="image/*" multiple>
                        <label for="schoolImages" class="file-input-label"><i class="fas fa-images"></i> Add Images</label>
                        <span class="file-name-display" id="imagesFileName"></span>
                    </div>
                    <div id="imagesPreview" class="preview-section" style="display: none;">
                        <h4>Image Previews</h4>
                        <div class="preview-grid" id="imagesPreviewGrid"></div>
                    </div>
                </div>
                
                <!-- Videos Upload -->
                <div class="file-upload-group">
                    <label>School Videos (Multiple)</label>
                    <div class="file-input-wrapper">
                        <input type="file" id="schoolVideos" accept="video/*" multiple>
                        <label for="schoolVideos" class="file-input-label"><i class="fas fa-video"></i> Add Videos</label>
                        <span class="file-name-display" id="videosFileName"></span>
                    </div>
                    <div id="videosPreview" class="preview-section" style="display: none;">
                        <h4>Video Previews</h4>
                        <div class="preview-grid" id="videosPreviewGrid"></div>
                    </div>
                </div>
                
                <div class="modal-footer"><button type="button" class="btn-cancel" onclick="closeModal('schoolModal')">Cancel</button><button type="submit" class="btn-submit">Add School</button></div>
            </form>
        </div>
    </div>

    <!-- Events Modal -->
    <div id="eventsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2 id="eventModalTitle">Add Event</h2><button class="modal-close" onclick="closeModal('eventsModal')">&times;</button></div>
            <form id="eventsForm" onsubmit="handleSubmit(event, 'events')">
                <div class="form-row"><div class="form-group"><label for="eventName">Event Name *</label><input type="text" id="eventName" required></div><div class="form-group"><label for="eventDate">Date *</label><input type="date" id="eventDate" required></div></div>
                <div class="form-row"><div class="form-group"><label for="eventLocation">Location</label><input type="text" id="eventLocation"></div><div class="form-group"><label for="eventType">Type</label><input type="text" id="eventType"></div></div>
                <div class="form-group"><label for="eventAttendees">Expected Attendees</label><input type="number" id="eventAttendees"></div>
                <div class="modal-footer"><button type="button" class="btn-cancel" onclick="closeModal('eventsModal')">Cancel</button><button type="submit" class="btn-submit">Add Event</button></div>
            </form>
        </div>
    </div>

    <!-- Jobs Modal -->
    <div id="jobsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2 id="jobModalTitle">Add Job</h2><button class="modal-close" onclick="closeModal('jobsModal')">&times;</button></div>
            <form id="jobsForm" onsubmit="handleSubmit(event, 'jobs')">
                <div class="form-row"><div class="form-group"><label for="jobTitle">Job Title *</label><input type="text" id="jobTitle" required></div><div class="form-group"><label for="jobOrganization">Organization *</label><input type="text" id="jobOrganization" required></div></div>
                <div class="form-row"><div class="form-group"><label for="jobLocation">Location</label><input type="text" id="jobLocation"></div><div class="form-group"><label for="jobSalary">Salary (UGX)</label><input type="text" id="jobSalary"></div></div>
                <div class="form-group"><label for="jobDescription">Description</label><textarea id="jobDescription" style="resize: vertical; min-height: 100px;"></textarea></div>
                <div class="modal-footer"><button type="button" class="btn-cancel" onclick="closeModal('jobsModal')">Cancel</button><button type="submit" class="btn-submit">Add Job</button></div>
            </form>
        </div>
    </div>

    <!-- Bursaries Modal -->
    <div id="bursariesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2 id="bursaryModalTitle">Add Bursary</h2><button class="modal-close" onclick="closeModal('bursariesModal')">&times;</button></div>
            <form id="bursariesForm" onsubmit="handleSubmit(event, 'bursaries')">
                <div class="form-row"><div class="form-group"><label for="bursaryName">Program Name *</label><input type="text" id="bursaryName" required></div><div class="form-group"><label for="bursarySponsor">Sponsor *</label><input type="text" id="bursarySponsor" required></div></div>
                <div class="form-row"><div class="form-group"><label for="bursaryAmount">Amount (UGX) *</label><input type="number" id="bursaryAmount" required></div><div class="form-group"><label for="bursaryCategory">Category</label><input type="text" id="bursaryCategory"></div></div>
                <div class="form-row"><div class="form-group"><label for="bursaryDeadline">Deadline</label><input type="date" id="bursaryDeadline"></div></div>
                <div class="modal-footer"><button type="button" class="btn-cancel" onclick="closeModal('bursariesModal')">Cancel</button><button type="submit" class="btn-submit">Add Bursary</button></div>
            </form>
        </div>
    </div>

    <!-- Agents Modal -->
    <div id="agentsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2 id="agentModalTitle">Add Agent</h2><button class="modal-close" onclick="closeModal('agentsModal')">&times;</button></div>
            <form id="agentsForm" onsubmit="handleSubmit(event, 'agents')">
                <div class="form-row"><div class="form-group"><label for="agentName">Name *</label><input type="text" id="agentName" required></div><div class="form-group"><label for="agentEmail">Email *</label><input type="email" id="agentEmail" required></div></div>
                <div class="form-row"><div class="form-group"><label for="agentPhone">Phone *</label><input type="tel" id="agentPhone" required></div><div class="form-group"><label for="agentRegion">Region</label><input type="text" id="agentRegion"></div></div>
                <div class="form-row"><div class="form-group"><label for="agentStatus">Status</label><select id="agentStatus"><option value="Active">Active</option><option value="Inactive">Inactive</option></select></div></div>
                <div class="modal-footer"><button type="button" class="btn-cancel" onclick="closeModal('agentsModal')">Cancel</button><button type="submit" class="btn-submit">Add Agent</button></div>
            </form>
        </div>
    </div>

    <!-- Papers Modal -->
    <div id="papersModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2 id="paperModalTitle">Add Paper</h2><button class="modal-close" onclick="closeModal('papersModal')">&times;</button></div>
            <form id="papersForm" onsubmit="handleSubmit(event, 'papers')">
                <div class="form-row"><div class="form-group"><label for="paperSubject">Subject *</label><input type="text" id="paperSubject" required></div><div class="form-group"><label for="paperYear">Exam Year *</label><input type="number" id="paperYear" required></div></div>
                <div class="form-row"><div class="form-group"><label for="paperLevel">Exam Level *</label><select id="paperLevel" required><option value="">Select</option><option value="UCE">UCE</option><option value="UACE">UACE</option><option value="O-Level">O-Level</option><option value="A-Level">A-Level</option></select></div><div class="form-group"><label for="paperSchool">School</label><input type="text" id="paperSchool"></div></div>
                <div class="form-group"><label for="paperFile">File URL/Name</label><input type="text" id="paperFile"></div>
                <div class="modal-footer"><button type="button" class="btn-cancel" onclick="closeModal('papersModal')">Cancel</button><button type="submit" class="btn-submit">Add Paper</button></div>
            </form>
        </div>
    </div>

    <!-- Suggestions Modal -->
    <div id="suggestionsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2 id="suggestionModalTitle">Log Suggestion</h2><button class="modal-close" onclick="closeModal('suggestionsModal')">&times;</button></div>
            <form id="suggestionsForm" onsubmit="handleSubmit(event, 'suggestions')">
                <div class="form-row"><div class="form-group"><label for="suggestionFrom">From *</label><input type="text" id="suggestionFrom" required></div><div class="form-group"><label for="suggestionSubject">Subject *</label><input type="text" id="suggestionSubject" required></div></div>
                <div class="form-group"><label for="suggestionMessage">Message</label><textarea id="suggestionMessage" required style="resize: vertical; min-height: 100px;"></textarea></div>
                <div class="form-row"><div class="form-group"><label for="suggestionStatus">Status</label><select id="suggestionStatus"><option value="New">New</option><option value="In Review">In Review</option><option value="Resolved">Resolved</option></select></div></div>
                <div class="modal-footer"><button type="button" class="btn-cancel" onclick="closeModal('suggestionsModal')">Cancel</button><button type="submit" class="btn-submit">Log Suggestion</button></div>
            </form>
        </div>
    </div>

    <!-- Users Modal -->
    <div id="usersModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2 id="userModalTitle">Add User</h2><button class="modal-close" onclick="closeModal('usersModal')">&times;</button></div>
            <form id="usersForm" onsubmit="handleSubmit(event, 'users')">
                <div class="form-row"><div class="form-group"><label for="userName">Full Name *</label><input type="text" id="userName" required></div><div class="form-group"><label for="userEmail">Email *</label><input type="email" id="userEmail" required></div></div>
                <div class="form-row"><div class="form-group"><label for="userRole">Role *</label><select id="userRole" required><option value="">Select Role</option><option value="Admin">Admin</option><option value="Moderator">Moderator</option><option value="User">User</option><option value="Agent">Agent</option></select></div><div class="form-group"><label for="userStatus">Status</label><select id="userStatus"><option value="Active">Active</option><option value="Inactive">Inactive</option></select></div></div>
                <div class="form-group"><label for="userPassword">Password (optional)</label><input type="password" id="userPassword" placeholder="Auto-generated if empty"></div>
                <div class="modal-footer"><button type="button" class="btn-cancel" onclick="closeModal('usersModal')">Cancel</button><button type="submit" class="btn-submit">Add User</button></div>
            </form>
        </div>
    </div>

    <footer>
        <div class="footer-content">
            <div class="footer-section"><h3>EduBridge Uganda</h3><p>Supporting Ugandan education</p><div class="social-links"><a href="#"><i class="fab fa-facebook-f"></i></a><a href="#"><i class="fab fa-twitter"></i></a></div></div>
            <div class="footer-section"><h3>Contact</h3><p>Kampala, Uganda</p><p>admin@edubridge.ug</p><p>Tel: +256 700 123456</p></div>
            <div class="footer-section"><h3>UNEB resources</h3><p>UCE & UACE past papers</p></div>
        </div>
        <div class="footer-bottom"><p>© 2025 EduBridge Uganda · built for local schools</p></div>
    </footer>
</div>
<script src="js/api.js"></script>
<script>
    // ===== DATA ARRAYS =====
    let schoolsData = [], eventsData = [], jobsData = [], bursariesData = [], agentsData = [], papersData = [], suggestionsData = [], usersData = [];
    let editingId = {}, editingSectionType = null;

    // ===== AUTHENTICATION & INITIALIZATION =====
    document.addEventListener('DOMContentLoaded', async () => {
        const user = await checkAdminAccess();
        if (!user) { window.location.href = 'login.html'; return; }
        document.getElementById('sidebarUserName').innerText = user.name || user.email;
        document.getElementById('sidebarUserEmail').innerText = user.email;
        
        // Initialize all data
        initializeAllData();
        
        // Listen for all data changes
        ['schools', 'events', 'jobs', 'bursaries', 'agents', 'papers', 'suggestions', 'users'].forEach(type => {
            document.addEventListener(`${type}DataChanged`, () => updateStatsAndCalculations());
        });
        
        setupEventListeners();
        attachHeaderInteractions();
        updateStatsAndCalculations();
    });

    function checkAdminAccess() {
        try {
            const userStr = localStorage.getItem('cpace_user');
            if (userStr) {
                const user = JSON.parse(userStr);
                if (user.is_admin || user.role === 'admin') return user;
            }
            return null;
        } catch (error) {
            console.error('Auth check error:', error);
            return null;
        }
    }

    // ===== UNIVERSAL INITIALIZATION =====
    function initializeAllData() {
        initializeData('schools', [
            { id:1, name:"Kampala High School", district:"Kampala", category:"Secondary", students:1250, contact_email:"khs@school.ug", contact_phone:"+256 700 111111", address:"Kampala, Uganda" },
            { id:2, name:"Jinja College", district:"Jinja", category:"Secondary", students:980, contact_email:"jinja@college.ug", contact_phone:"+256 700 222222", address:"Jinja, Uganda" },
            { id:3, name:"Gulu Public School", district:"Gulu", category:"Primary", students:720, contact_email:"gulu@school.ug", contact_phone:"+256 700 333333", address:"Gulu, Uganda" }
        ]);
        initializeData('events', [
            { id:1, name:"Education Summit 2025", date:"2025-03-15", location:"Kampala", type:"Conference", attendees:200 },
            { id:2, name:"Teachers Training Workshop", date:"2025-04-20", location:"Entebbe", type:"Workshop", attendees:50 }
        ]);
        initializeData('jobs', [
            { id:1, title:"Math Teacher", organization:"Kampala High School", location:"Kampala", salary:"UGX 2M-3M", description:"Full-time mathematics educator" },
            { id:2, title:"Science Lab Technician", organization:"Jinja College", location:"Jinja", salary:"UGX 1.5M-2M", description:"Laboratory management & maintenance" }
        ]);
        initializeData('bursaries', [
            { id:1, name:"Merit Scholarship Program", sponsor:"Ministry of Education", amount:500000000, category:"Secondary", deadline:"2025-05-30" },
            { id:2, name:"Girls Education Fund", sponsor:"UNICEF Uganda", amount:300000000, category:"Primary", deadline:"2025-06-15" }
        ]);
        initializeData('agents', [
            { id:1, name:"John Ochieng", email:"john@edubridge.ug", phone:"+256 701 123456", region:"Kampala", status:"Active" },
            { id:2, name:"Sarah Nakamatte", email:"sarah@edubridge.ug", phone:"+256 702 234567", region:"Jinja", status:"Active" }
        ]);
        initializeData('papers', [
            { id:1, subject:"Mathematics", year:2024, level:"UCE", school:"Kampala High", file:"Math_UCE_2024.pdf" },
            { id:2, subject:"English", year:2024, level:"UACE", school:"Jinja College", file:"English_UACE_2024.pdf" }
        ]);
        initializeData('suggestions', [
            { id:1, from:"Teacher John", subject:"Improve platform UX", message:"Add dark mode and mobile app", date:"2025-02-10", status:"In Review" },
            { id:2, from:"Admin Staff", subject:"Add calendar feature", message:"Integration with school calendars", date:"2025-02-15", status:"New" }
        ]);
        initializeData('users', [
            { id:1, name:"Admin User", email:"admin@thrive.com", role:"Admin", joined:"2025-01-01", status:"Active" },
            { id:2, name:"Moderator Staff", email:"mod@thrive.com", role:"Moderator", joined:"2025-01-15", status:"Active" }
        ]);
    }

    function initializeData(type, defaults) {
        try {
            const stored = localStorage.getItem(`edubridge_${type}`);
            window[`${type}Data`] = stored ? JSON.parse(stored) : defaults;
            saveDataToStorage(type);
        } catch (error) {
            console.error(`Error initializing ${type}:`, error);
            window[`${type}Data`] = [];
        }
    }

    function saveDataToStorage(type) {
        try {
            const data = window[`${type}Data`];
            localStorage.setItem(`edubridge_${type}`, JSON.stringify(data));
            document.dispatchEvent(new CustomEvent(`${type}DataChanged`, { detail: { data } }));
        } catch (error) {
            console.error(`Error saving ${type}:`, error);
        }
    }

    // ===== UNIVERSAL CRUD FUNCTIONS =====
    async function loadData(type) {
        const stored = localStorage.getItem(`edubridge_${type}`);
        if (stored) {
            window[`${type}Data`] = JSON.parse(stored);
            renderTable(type);
            return;
        }
        // Try API if no local data
        try {
            const API_URL = api.API_BASE_URL || 'http://localhost:5000/api';
            const response = await fetch(`${API_URL}/${type}`);
            if (response.ok) {
                const result = await response.json();
                window[`${type}Data`] = result[type] || [];
                saveDataToStorage(type);
            }
        } catch (error) {
            console.log(`Using local data for ${type}`);
        }
        renderTable(type);
    }

    function renderTable(type) {
        const tbody = document.getElementById(`${type}TableBody`);
        const data = window[`${type}Data`];
        if (!tbody) return;
        // Apply global filters (search text and date range)
        const filterText = (window.mainFilter || '').toLowerCase().trim();
        const startDate = window.mainDateStart ? new Date(window.mainDateStart) : null;
        const endDate = window.mainDateEnd ? new Date(window.mainDateEnd) : null;

        let filtered = Array.isArray(data) ? data.slice() : [];
        if (filterText) {
            filtered = filtered.filter(item => JSON.stringify(item).toLowerCase().includes(filterText));
        }
        if ((startDate || endDate) && (type === 'events' || type === 'bursaries' || type === 'jobs')) {
            filtered = filtered.filter(item => {
                const possibleDate = item.date || item.deadline || item.posted || null;
                if (!possibleDate) return true;
                const d = new Date(possibleDate);
                if (isNaN(d)) return true;
                if (startDate && d < startDate) return false;
                if (endDate && d > endDate) return false;
                return true;
            });
        }

        if (filtered.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 40px; color: #999;">No ${type} matched</td></tr>`;
            return;
        }

        const columns = {
            schools: (item) => `<tr><td><strong>${item.name}</strong></td><td>${item.category}</td><td>${item.district}</td><td>${item.students || 0}</td><td>${item.contact_email || 'N/A'}</td><td><button class="btn-edit-table" onclick="editItem(${item.id}, 'schools')"><i class="fas fa-edit"></i></button><button class="btn-delete-table" onclick="deleteItem(${item.id}, 'schools')"><i class="fas fa-trash"></i></button></td></tr>`,
            events: (item) => `<tr><td><strong>${item.name}</strong></td><td>${item.date}</td><td>${item.location}</td><td>${item.type}</td><td>${item.attendees || 0}</td><td><button class="btn-edit-table" onclick="editItem(${item.id}, 'events')"><i class="fas fa-edit"></i></button><button class="btn-delete-table" onclick="deleteItem(${item.id}, 'events')"><i class="fas fa-trash"></i></button></td></tr>`,
            jobs: (item) => `<tr><td><strong>${item.title}</strong></td><td>${item.organization}</td><td>${item.location}</td><td>${item.salary}</td><td>${new Date().toLocaleDateString()}</td><td><button class="btn-edit-table" onclick="editItem(${item.id}, 'jobs')"><i class="fas fa-edit"></i></button><button class="btn-delete-table" onclick="deleteItem(${item.id}, 'jobs')"><i class="fas fa-trash"></i></button></td></tr>`,
            bursaries: (item) => `<tr><td><strong>${item.name}</strong></td><td>${item.sponsor}</td><td>UGX ${(item.amount/1000000).toFixed(1)}M</td><td>${item.category}</td><td>${item.deadline}</td><td><button class="btn-edit-table" onclick="editItem(${item.id}, 'bursaries')"><i class="fas fa-edit"></i></button><button class="btn-delete-table" onclick="deleteItem(${item.id}, 'bursaries')"><i class="fas fa-trash"></i></button></td></tr>`,
            agents: (item) => `<tr><td><strong>${item.name}</strong></td><td>${item.email}</td><td>${item.phone}</td><td>${item.region}</td><td><span style="padding: 4px 12px; background: #d1fae5; color: #065f46; border-radius: 4px; font-size: 12px;">${item.status}</span></td><td><button class="btn-edit-table" onclick="editItem(${item.id}, 'agents')"><i class="fas fa-edit"></i></button><button class="btn-delete-table" onclick="deleteItem(${item.id}, 'agents')"><i class="fas fa-trash"></i></button></td></tr>`,
            papers: (item) => `<tr><td>${item.subject}</td><td>${item.year}</td><td>${item.level}</td><td>${item.school || 'N/A'}</td><td>${item.file || 'N/A'}</td><td><button class="btn-edit-table" onclick="editItem(${item.id}, 'papers')"><i class="fas fa-edit"></i></button><button class="btn-delete-table" onclick="deleteItem(${item.id}, 'papers')"><i class="fas fa-trash"></i></button></td></tr>`,
            suggestions: (item) => `<tr><td>${item.from}</td><td><strong>${item.subject}</strong></td><td>${item.message.substring(0, 40)}...</td><td>${item.date}</td><td><span style="padding: 4px 12px; background: #dbeafe; color: #0c2d6b; border-radius: 4px; font-size: 12px;">${item.status}</span></td><td><button class="btn-edit-table" onclick="editItem(${item.id}, 'suggestions')"><i class="fas fa-edit"></i></button><button class="btn-delete-table" onclick="deleteItem(${item.id}, 'suggestions')"><i class="fas fa-trash"></i></button></td></tr>`,
            users: (item) => `<tr><td><strong>${item.name}</strong></td><td>${item.email}</td><td>${item.role}</td><td>${item.joined}</td><td><span style="padding: 4px 12px; background: #d1fae5; color: #065f46; border-radius: 4px; font-size: 12px;">${item.status}</span></td><td><button class="btn-edit-table" onclick="editItem(${item.id}, 'users')"><i class="fas fa-edit"></i></button><button class="btn-delete-table" onclick="deleteItem(${item.id}, 'users')"><i class="fas fa-trash"></i></button></td></tr>`
        };

        tbody.innerHTML = filtered.map(columns[type] || (() => '<tr><td>Error</td></tr>')).join('');
    }

    function openModal(type) {
        editingId[type] = null;
        editingSectionType = type;
        const form = document.getElementById(`${type}Form`);
        if (form) form.reset();
        
        // Reset file upload previews for schools
        if (type === 'schools') {
            document.getElementById('logoFileName').textContent = '';
            document.getElementById('logoPreview').style.display = 'none';
            document.getElementById('imagesFileName').textContent = '';
            document.getElementById('imagesPreview').style.display = 'none';
            document.getElementById('imagesPreviewGrid').innerHTML = '';
            document.getElementById('videosFileName').textContent = '';
            document.getElementById('videosPreview').style.display = 'none';
            document.getElementById('videosPreviewGrid').innerHTML = '';
        }
        
        document.getElementById(`${type}Modal`).classList.add('show');
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('show');
        editingSectionType = null;
    }

    // ===== FILE UPLOAD HANDLERS FOR SCHOOL MODAL =====
    document.addEventListener('DOMContentLoaded', () => {
        // Logo file upload handler
        const logoInput = document.getElementById('schoolLogo');
        if (logoInput) {
            logoInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    document.getElementById('logoFileName').textContent = file.name;
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const preview = document.getElementById('logoPreview');
                        const img = document.getElementById('logoPreviewImg');
                        img.src = event.target.result;
                        preview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // Images file upload handler (multiple)
        const imagesInput = document.getElementById('schoolImages');
        if (imagesInput) {
            imagesInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                if (files.length > 0) {
                    document.getElementById('imagesFileName').textContent = `${files.length} image(s) selected`;
                    const grid = document.getElementById('imagesPreviewGrid');
                    grid.innerHTML = '';
                    
                    files.forEach((file, index) => {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            const item = document.createElement('div');
                            item.className = 'preview-item';
                            item.innerHTML = `
                                <img src="${event.target.result}" alt="Image preview">
                                <button type="button" class="preview-remove" onclick="removeImagePreview(this)" data-index="${index}">&times;</button>
                            `;
                            grid.appendChild(item);
                        };
                        reader.readAsDataURL(file);
                    });
                    
                    document.getElementById('imagesPreview').style.display = 'block';
                }
            });
        }

        // Videos file upload handler (multiple)
        const videosInput = document.getElementById('schoolVideos');
        if (videosInput) {
            videosInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                if (files.length > 0) {
                    document.getElementById('videosFileName').textContent = `${files.length} video(s) selected`;
                    const grid = document.getElementById('videosPreviewGrid');
                    grid.innerHTML = '';
                    
                    files.forEach((file, index) => {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            const item = document.createElement('div');
                            item.className = 'preview-item';
                            item.innerHTML = `
                                <video src="${event.target.result}" controls style="width: 100%; height: 100%; object-fit: cover;"></video>
                                <button type="button" class="preview-remove" onclick="removeVideoPreview(this)" data-index="${index}">&times;</button>
                            `;
                            grid.appendChild(item);
                        };
                        reader.readAsDataURL(file);
                    });
                    
                    document.getElementById('videosPreview').style.display = 'block';
                }
            });
        }
    });

    function removeImagePreview(btn) {
        btn.parentElement.remove();
        const grid = document.getElementById('imagesPreviewGrid');
        if (grid.children.length === 0) {
            document.getElementById('imagesPreview').style.display = 'none';
            document.getElementById('schoolImages').value = '';
            document.getElementById('imagesFileName').textContent = '';
        }
    }

    function removeVideoPreview(btn) {
        btn.parentElement.remove();
        const grid = document.getElementById('videosPreviewGrid');
        if (grid.children.length === 0) {
            document.getElementById('videosPreview').style.display = 'none';
            document.getElementById('schoolVideos').value = '';
            document.getElementById('videosFileName').textContent = '';
        }
    }

    function editItem(id, type) {
        const item = window[`${type}Data`].find(i => i.id === id);
        if (!item) return;
        editingId[type] = id;
        editingSectionType = type;
        populateForm(type, item);
        document.getElementById(`${type}Modal`).classList.add('show');
    }

    function populateForm(type, item) {
        const mappings = {
            schools: () => {
                document.getElementById('schoolName').value = item.name;
                document.getElementById('schoolCategory').value = item.category;
                document.getElementById('schoolDistrict').value = item.district;
                document.getElementById('schoolStudents').value = item.students || '';
                document.getElementById('schoolEmail').value = item.contact_email || '';
                document.getElementById('schoolPhone').value = item.contact_phone || '';
                document.getElementById('schoolAddress').value = item.address || '';
            },
            events: () => {
                document.getElementById('eventName').value = item.name;
                document.getElementById('eventDate').value = item.date;
                document.getElementById('eventLocation').value = item.location;
                document.getElementById('eventType').value = item.type;
                document.getElementById('eventAttendees').value = item.attendees || '';
            },
            jobs: () => {
                document.getElementById('jobTitle').value = item.title;
                document.getElementById('jobOrganization').value = item.organization;
                document.getElementById('jobLocation').value = item.location;
                document.getElementById('jobSalary').value = item.salary;
                document.getElementById('jobDescription').value = item.description || '';
            },
            bursaries: () => {
                document.getElementById('bursaryName').value = item.name;
                document.getElementById('bursarySponsor').value = item.sponsor;
                document.getElementById('bursaryAmount').value = item.amount;
                document.getElementById('bursaryCategory').value = item.category;
                document.getElementById('bursaryDeadline').value = item.deadline;
            },
            agents: () => {
                document.getElementById('agentName').value = item.name;
                document.getElementById('agentEmail').value = item.email;
                document.getElementById('agentPhone').value = item.phone;
                document.getElementById('agentRegion').value = item.region;
                document.getElementById('agentStatus').value = item.status;
            },
            papers: () => {
                document.getElementById('paperSubject').value = item.subject;
                document.getElementById('paperYear').value = item.year;
                document.getElementById('paperLevel').value = item.level;
                document.getElementById('paperSchool').value = item.school || '';
                document.getElementById('paperFile').value = item.file || '';
            },
            suggestions: () => {
                document.getElementById('suggestionFrom').value = item.from;
                document.getElementById('suggestionSubject').value = item.subject;
                document.getElementById('suggestionMessage').value = item.message;
                document.getElementById('suggestionStatus').value = item.status;
            },
            users: () => {
                document.getElementById('userName').value = item.name;
                document.getElementById('userEmail').value = item.email;
                document.getElementById('userRole').value = item.role;
                document.getElementById('userStatus').value = item.status;
            }
        };
        (mappings[type] || (() => {}))();
    }

    async function handleSubmit(event, type) {
        event.preventDefault();
        const extractors = {
            schools: () => ({
                name: document.getElementById('schoolName').value,
                category: document.getElementById('schoolCategory').value,
                district: document.getElementById('schoolDistrict').value,
                students: parseInt(document.getElementById('schoolStudents').value) || 0,
                contact_email: document.getElementById('schoolEmail').value,
                contact_phone: document.getElementById('schoolPhone').value,
                address: document.getElementById('schoolAddress').value
            }),
            events: () => ({
                name: document.getElementById('eventName').value,
                date: document.getElementById('eventDate').value,
                location: document.getElementById('eventLocation').value,
                type: document.getElementById('eventType').value,
                attendees: parseInt(document.getElementById('eventAttendees').value) || 0
            }),
            jobs: () => ({
                title: document.getElementById('jobTitle').value,
                organization: document.getElementById('jobOrganization').value,
                location: document.getElementById('jobLocation').value,
                salary: document.getElementById('jobSalary').value,
                description: document.getElementById('jobDescription').value
            }),
            bursaries: () => ({
                name: document.getElementById('bursaryName').value,
                sponsor: document.getElementById('bursarySponsor').value,
                amount: parseInt(document.getElementById('bursaryAmount').value),
                category: document.getElementById('bursaryCategory').value,
                deadline: document.getElementById('bursaryDeadline').value
            }),
            agents: () => ({
                name: document.getElementById('agentName').value,
                email: document.getElementById('agentEmail').value,
                phone: document.getElementById('agentPhone').value,
                region: document.getElementById('agentRegion').value,
                status: document.getElementById('agentStatus').value
            }),
            papers: () => ({
                subject: document.getElementById('paperSubject').value,
                year: parseInt(document.getElementById('paperYear').value),
                level: document.getElementById('paperLevel').value,
                school: document.getElementById('paperSchool').value,
                file: document.getElementById('paperFile').value
            }),
            suggestions: () => ({
                from: document.getElementById('suggestionFrom').value,
                subject: document.getElementById('suggestionSubject').value,
                message: document.getElementById('suggestionMessage').value,
                date: new Date().toISOString().split('T')[0],
                status: document.getElementById('suggestionStatus').value
            }),
            users: () => ({
                name: document.getElementById('userName').value,
                email: document.getElementById('userEmail').value,
                role: document.getElementById('userRole').value,
                joined: new Date().toISOString().split('T')[0],
                status: document.getElementById('userStatus').value
            })
        };

        const data = (extractors[type] || (() => ({})))();
        const id = editingId[type];
        
        // Special handling for schools with file uploads
        if (type === 'schools') {
            try {
                const formData = new FormData();
                
                // Add form fields
                formData.append('name', data.name);
                formData.append('category', data.category);
                formData.append('district', data.district);
                formData.append('students', data.students);
                formData.append('contact_email', data.contact_email);
                formData.append('contact_phone', data.contact_phone);
                formData.append('address', data.address);
                
                // Add files if selected
                const logoFile = document.getElementById('schoolLogo').files[0];
                if (logoFile) {
                    formData.append('logo', logoFile);
                }
                
                const imagesFiles = document.getElementById('schoolImages').files;
                for (let i = 0; i < imagesFiles.length; i++) {
                    formData.append('images', imagesFiles[i]);
                }
                
                const videosFiles = document.getElementById('schoolVideos').files;
                for (let i = 0; i < videosFiles.length; i++) {
                    formData.append('videos', videosFiles[i]);
                }
                
                // Attempt to send to backend API
                const apiEndpoint = id ? `/api/schools/${id}` : '/api/schools';
                const method = id ? 'PUT' : 'POST';
                
                try {
                    const response = await fetch(apiEndpoint, {
                        method: method,
                        body: formData,
                        credentials: 'include'
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API error: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    // Update local data
                    if (id) {
                        const idx = schoolsData.findIndex(i => i.id === id);
                        if (idx >= 0) {
                            schoolsData[idx] = { ...schoolsData[idx], ...result };
                            showAlert('schools', `✓ School updated!`, 'success');
                        }
                    } else {
                        schoolsData.push(result);
                        showAlert('schools', `✓ School added!`, 'success');
                    }
                } catch (apiError) {
                    console.log('API not available, using local storage:', apiError);
                    
                    // Fallback: Store locally with file references
                    if (id) {
                        const idx = schoolsData.findIndex(i => i.id === id);
                        if (idx >= 0) {
                            schoolsData[idx] = { id, ...data, logo: logoFile ? logoFile.name : null, images_count: imagesFiles.length, videos_count: videosFiles.length };
                            showAlert('schools', `✓ School updated (local)!`, 'success');
                        }
                    } else {
                        const newId = Math.max(...schoolsData.map(i => i.id || 0), 0) + 1;
                        schoolsData.push({ 
                            id: newId, 
                            ...data, 
                            logo: logoFile ? logoFile.name : null,
                            images_count: imagesFiles.length,
                            videos_count: videosFiles.length
                        });
                        showAlert('schools', `✓ School added (local)!`, 'success');
                    }
                }
                
                saveDataToStorage('schools');
                closeModal('schoolsModal');
                loadData('schools');
                return;
            } catch (error) {
                showAlert('schools', `✗ Error: ${error.message}`, 'error');
                return;
            }
        }
        
        // Standard handling for other types (no files)
        if (id) {
            const idx = window[`${type}Data`].findIndex(i => i.id === id);
            if (idx >= 0) {
                window[`${type}Data`][idx] = { ...window[`${type}Data`][idx], ...data };
                showAlert(type, `✓ ${type.slice(0,-1)} updated!`, 'success');
            }
        } else {
            const newId = Math.max(...window[`${type}Data`].map(i => i.id || 0), 0) + 1;
            window[`${type}Data`].push({ id: newId, ...data });
            showAlert(type, `✓ ${type.slice(0,-1)} added!`, 'success');
        }

        saveDataToStorage(type);
        closeModal(`${type}Modal`);
        loadData(type);
    }

    async function deleteItem(id, type) {
        if (!confirm(`Delete this ${type.slice(0,-1)}?`)) return;
        window[`${type}Data`] = window[`${type}Data`].filter(i => i.id !== id);
        saveDataToStorage(type);
        showAlert(type, `✓ ${type.slice(0,-1)} deleted!`, 'success');
        loadData(type);
    }

    function showAlert(section, message, type) {
        const alertDiv = document.getElementById(`${section}Alert`);
        if (!alertDiv) return;
        const alert = document.createElement('div');
        alert.className = `alert alert-${type}`;
        alert.textContent = message;
        alertDiv.innerHTML = '';
        alertDiv.appendChild(alert);
        setTimeout(() => alert.remove(), 4000);
    }

    // ===== EVENT LISTENERS & UI =====
    function setupEventListeners() {
        // Navigation
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const section = link.dataset.section;
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                document.querySelectorAll('.section-content').forEach(c => c.classList.remove('active'));
                const target = document.getElementById(`${section}-section`);
                if (target) target.classList.add('active');
                document.getElementById('headerTitle').textContent = section.charAt(0).toUpperCase() + section.slice(1);
                if (section !== 'dashboard') loadData(section);
            });
        });

        // Add buttons
        ['schools', 'events', 'jobs', 'bursaries', 'agents', 'papers', 'suggestions', 'users'].forEach(type => {
            const btn = document.getElementById(`add${type.charAt(0).toUpperCase() + type.slice(1, -1)}Btn`);
            if (btn) btn.addEventListener('click', () => openModal(type));
        });

        // Refresh
        if (document.getElementById('refreshBtn')) {
            document.getElementById('refreshBtn').addEventListener('click', () => {
                updateStatsAndCalculations();
                showAlert('schools', '✓ Dashboard refreshed', 'success');
            });
        }

        // Logout
        if (document.getElementById('logoutBtn')) {
            document.getElementById('logoutBtn').addEventListener('click', async () => {
                if (confirm('Logout?')) {
                    if (typeof api !== 'undefined' && api.logout) await api.logout();
                    else localStorage.removeItem('cpace_user');
                    window.location.href = 'login.html';
                }
            });
        }
    }

    // Header interactions: search, date filters, view toggle
    function attachHeaderInteractions() {
        window.mainFilter = '';
        window.mainDateStart = null;
        window.mainDateEnd = null;

        const search = document.getElementById('globalSearch');
        const clear = document.getElementById('clearSearch');
        const dateStart = document.getElementById('dateStart');
        const dateEnd = document.getElementById('dateEnd');
        const viewCompact = document.getElementById('viewCompact');
        const viewExpanded = document.getElementById('viewExpanded');

        if (search) {
            let t;
            search.addEventListener('input', (e) => {
                clear.style.display = e.target.value ? 'block' : 'none';
                clear.title = e.target.value ? 'Clear' : '';
                clear.disabled = !e.target.value;
                clear.classList.toggle('has-text', !!e.target.value);
                clear.classList.toggle('hidden', !e.target.value);
                clear.style.opacity = e.target.value ? '1' : '0.5';
                window.mainFilter = e.target.value;
                clearTimeout(t);
                t = setTimeout(() => applyMainFilters(), 300);
            });
        }
        if (clear) clear.addEventListener('click', () => { if (search) search.value=''; window.mainFilter=''; applyMainFilters(); });

        if (dateStart) dateStart.addEventListener('change', (e) => { window.mainDateStart = e.target.value || null; applyMainFilters(); });
        if (dateEnd) dateEnd.addEventListener('change', (e) => { window.mainDateEnd = e.target.value || null; applyMainFilters(); });

        if (viewCompact && viewExpanded) {
            viewCompact.addEventListener('click', () => { viewCompact.classList.add('active'); viewExpanded.classList.remove('active'); document.body.classList.add('compact'); });
            viewExpanded.addEventListener('click', () => { viewExpanded.classList.add('active'); viewCompact.classList.remove('active'); document.body.classList.remove('compact'); });
        }
    }

    function applyMainFilters() {
        // Re-render the currently visible section to show filtered results
        const active = document.querySelector('.section-content.active');
        if (!active) return;
        const id = active.id;
        const type = id ? id.replace('-section','') : null;
        if (type) renderTable(type);
        // small stat card pulse to draw attention
        animateStatCards();
    }

    function animateStatCards() {
        document.querySelectorAll('.stat-value').forEach(el => {
            el.classList.add('pop');
            setTimeout(() => el.classList.remove('pop'), 650);
        });
    }

    // ===== DASHBOARD STATS =====
    async function updateStatsAndCalculations() {
        try {
            // Ensure all datasets are loaded
            await Promise.all([
                loadData('schools'), loadData('events'), loadData('jobs'), loadData('bursaries'),
                loadData('agents'), loadData('papers'), loadData('suggestions'), loadData('users')
            ]);

            // Compute core metrics
            const totalSchools = (schoolsData || []).length;
            const totalStudents = (schoolsData || []).reduce((a,s) => a + (s.students || 0), 0);
            const avgStudents = totalSchools > 0 ? Math.round(totalStudents / totalSchools) : 0;

            // Upcoming events within 30 days
            const now = new Date();
            const in30 = new Date(); in30.setDate(now.getDate() + 30);
            const upcomingEvents = (eventsData || []).filter(ev => {
                if (!ev || !ev.date) return false;
                const d = new Date(ev.date);
                return d >= now && d <= in30;
            }).length;

            // Jobs and agents
            const totalJobs = (jobsData || []).length;
            const activeAgents = (agentsData || []).filter(a => (a.status || '').toLowerCase() === 'active').length;

            // Bursary stats
            const totalBursaries = (bursariesData || []).length;
            const bursarySum = (bursariesData || []).reduce((a,b) => a + (b.amount || 0), 0);
            const avgBursary = totalBursaries > 0 ? Math.round(bursarySum / totalBursaries) : 0;

            // Other counts
            const totalPapers = (papersData || []).length;
            const totalUsers = (usersData || []).length;
            const suggestionsPending = (suggestionsData || []).filter(s => (s.status || '').toLowerCase() !== 'resolved').length;

            // Update DOM elements (guarded)
            if (document.getElementById('totalSchools')) document.getElementById('totalSchools').innerText = totalSchools;
            if (document.getElementById('totalStudents')) document.getElementById('totalStudents').innerText = totalStudents.toLocaleString();
            if (document.getElementById('avgStudents')) document.getElementById('avgStudents').innerText = avgStudents.toLocaleString();
            if (document.getElementById('upcomingEvents')) document.getElementById('upcomingEvents').innerText = upcomingEvents;
            if (document.getElementById('totalEvents')) document.getElementById('totalEvents').innerText = (eventsData || []).length;
            if (document.getElementById('totalJobs')) document.getElementById('totalJobs').innerText = totalJobs;
            if (document.getElementById('openJobs')) document.getElementById('openJobs').innerText = totalJobs + ' total';
            if (document.getElementById('activeAgents')) document.getElementById('activeAgents').innerText = activeAgents;
            if (document.getElementById('totalBursaries')) document.getElementById('totalBursaries').innerText = totalBursaries;
            if (document.getElementById('bursaryTotal')) document.getElementById('bursaryTotal').innerText = bursarySum.toLocaleString();
            if (document.getElementById('avgBursary')) document.getElementById('avgBursary').innerText = avgBursary.toLocaleString();
            if (document.getElementById('totalPapers')) document.getElementById('totalPapers').innerText = totalPapers;
            if (document.getElementById('totalUsers')) document.getElementById('totalUsers').innerText = totalUsers;
            if (document.getElementById('suggestionsPending')) document.getElementById('suggestionsPending').innerText = suggestionsPending;

            // Refresh visualizations
            initializeCharts();
        } catch (error) {
            console.error('Error updating stats:', error);
        }
    }

    function initializeCharts() {
        if (window.categoryPie) window.categoryPie.destroy();
        if (window.growthBar) window.growthBar.destroy();
        if (window.appLine) window.appLine.destroy();
        if (window.resRadar) window.resRadar.destroy();
        // Set nicer global defaults
        Chart.defaults.font.family = "Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial";
        Chart.defaults.font.size = 12;
        Chart.defaults.color = '#334155';

        const districtCount = {};
        schoolsData.forEach(s => { districtCount[s.district || 'Unknown'] = (districtCount[s.district || 'Unknown'] || 0) + 1; });

        function createGradient(ctx, w, h, c1, c2) {
            const g = ctx.createLinearGradient(0, 0, w, h);
            g.addColorStop(0, c1);
            g.addColorStop(1, c2);
            return g;
        }

        // PIE / DOUGHNUT: refined style with cutout and smooth hover
        const pieCtx = document.getElementById('categoryPieChart');
        if (pieCtx) {
            const labels = Object.keys(districtCount);
            const values = Object.values(districtCount);
            const baseColors = ['#10b981','#f59e0b','#06b6d4','#0891b2','#0e7490','#059669','#fbbf24','#d4af37'];
            const bg = labels.map((l,i) => baseColors[i % baseColors.length]);
            window.categoryPie = new Chart(pieCtx, {
                type: 'doughnut',
                data: { labels, datasets: [{ data: values, backgroundColor: bg, hoverOffset: 12, borderWidth: 2, borderColor: '#fff' }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    cutout: '55%',
                    plugins: {
                        legend: { position: 'bottom', labels: { padding: 12, boxWidth: 12 } },
                        tooltip: { padding:10, bodySpacing:6, cornerRadius:8 }
                    },
                    animation: { duration: 700, easing: 'cubicBezier(.2,.8,.2,1)' }
                }
            });
        }

        // BAR: counts with gradient and rounded corners
        const barCtx = document.getElementById('growthBarChart');
        if (barCtx) {
            const w = barCtx.width || 400; const h = barCtx.height || 300;
            const g = createGradient(barCtx.getContext('2d'), 0, h, 'rgba(16,185,129,0.95)', 'rgba(6,182,212,0.25)');
            window.growthBar = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: ['Schools', 'Events', 'Jobs', 'Bursaries'],
                    datasets: [{ label: 'Count', data: [schoolsData.length, eventsData.length, jobsData.length, bursariesData.length], backgroundColor: g, borderRadius: 8, maxBarThickness: 48 }]
                },
                options: {
                    responsive:true, maintainAspectRatio:false,
                    plugins: { legend: { display:false }, tooltip: { mode:'index', intersect:false } },
                    interaction: { mode:'nearest', intersect:false },
                    scales: {
                        x: { grid: { display:false }, ticks: { color:'#64748b' } },
                        y: { beginAtZero:true, grid: { color:'rgba(15,23,42,0.06)' }, ticks: { color:'#64748b' } }
                    },
                    animation: { duration:800, easing:'cubicBezier(.2,.8,.2,1)' }
                }
            });
        }

        // LINE: smooth, area gradient and clear points
        const lineCtx = document.getElementById('applicationsLineChart');
        if (lineCtx) {
            const lw = lineCtx.getContext('2d');
            const h = lineCtx.height || 300;
            const gradA = createGradient(lw, 0, h, 'rgba(16,185,129,0.18)', 'rgba(16,185,129,0.02)');
            const gradB = createGradient(lw, 0, h, 'rgba(245,158,11,0.14)', 'rgba(245,158,11,0.02)');
            window.appLine = new Chart(lineCtx, {
                type: 'line',
                data: {
                    labels: ['Week1','Week2','Week3','Week4','Week5'],
                    datasets: [
                        { label:'Schools', data:[3,5,7,9,Math.max(5, schoolsData.length)], borderColor:'#059669', backgroundColor:gradA, fill:true, tension:0.36, pointRadius:3, pointHoverRadius:6 },
                        { label:'Users', data:[5,8,12,15,Math.max(8, usersData.length)], borderColor:'#d97706', backgroundColor:gradB, fill:true, tension:0.36, pointRadius:3, pointHoverRadius:6 }
                    ]
                },
                options: {
                    responsive:true, maintainAspectRatio:false,
                    plugins: { legend: { position:'bottom' }, tooltip: { mode:'index', intersect:false } },
                    scales: { x:{ grid:{ display:false }, ticks:{ color:'#64748b' } }, y:{ grid:{ color:'rgba(15,23,42,0.06)' }, ticks:{ color:'#64748b' } } },
                    animation: { duration:900, easing:'cubicBezier(.2,.8,.2,1)' }
                }
            });
        }

        // RADAR: cleaner colors and point emphasis
        const radarCtx = document.getElementById('resourceRadarChart');
        if (radarCtx) {
            window.resRadar = new Chart(radarCtx, {
                type: 'radar',
                data: {
                    labels: ['Schools','Events','Jobs','Bursaries','Users'],
                    datasets: [{ label:'Platform Status', data:[schoolsData.length, eventsData.length, jobsData.length, bursariesData.length, usersData.length], backgroundColor:'rgba(16,185,129,0.12)', borderColor:'#10b981', pointBackgroundColor:'#10b981', pointBorderColor:'#fff', pointHoverRadius:6 }]
                },
                options: {
                    responsive:true, maintainAspectRatio:false,
                    scales: { r: { beginAtZero:true, grid: { color:'rgba(15,23,42,0.06)' }, angleLines:{ color:'rgba(15,23,42,0.04)' }, pointLabels:{ color:'#64748b' } } },
                    plugins: { legend:{ display:false } },
                    elements: { line: { borderWidth:2 } },
                    animation: { duration:700 }
                }
            });
        }
    }
</script>
</body>
</html>